@inject FieldVisibilityService VisibilityService

<MudExpansionPanel HeaderClass="pa-0" Gutters="false" Dense="true" HideIcon="true">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Size="Size.Small">
                    <i class="fa-solid fa-sitemap fa-2xs"></i>
                </MudIcon>
                <MudText Typo="Typo.subtitle2">Target Persona</MudText>
            </MudStack>
            <VisibilityToggleButton 
                ShowOptional="@ShouldShowField" 
                OnVisibilityChanged="ToggleFieldVisibility"/>
        </MudStack>
    </TitleContent>
    <ChildContent>
        @if (File?.TargetPersonas != null)
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap" Spacing="0">
                @foreach (var targetPersona in File.TargetPersonas)
                {
                    <MudChip T="string"
                             OnClose="@(() => RemoveTargetPersona(targetPersona))"
                             Size="Size.Small"
                             CloseIcon="@Icons.Material.Filled.Close">
                        <MudText Typo="Typo.caption" Color="Color.Primary">@targetPersona</MudText>
                    </MudChip>
                }
            </MudStack>
        }
        <MudSelect T="string"
                   MultiSelection="true"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense"
                   Placeholder="Select Target Persona"
                   Underline="false"
                   SelectedValues="File.TargetPersonas"
                   SelectedValuesChanged="@(vals => File.TargetPersonas = vals.ToList())">
            @foreach (var targetPersona in _targetPersonas)
            {
                <MudSelectItem Value="@targetPersona">@targetPersona</MudSelectItem>
            }
        </MudSelect>
    </ChildContent>
</MudExpansionPanel>

@code {
    [Parameter] public UploadedFile? File { get; set; }
    [Parameter] public bool ShowOptional { get; set; }
    [Parameter] public EventCallback<bool> OnVisibilityChanged { get; set; }
    
    private const string FieldName = "TargetPersona";
    
    private bool ShouldShowField => VisibilityService.GetFieldVisibility(FieldName);
    
    protected override void OnInitialized()
    {
        
        VisibilityService.OnVisibilityChanged += OnVisibilityChangedHandler;
    }
    
    private async void OnVisibilityChangedHandler()
    {
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task ToggleFieldVisibility(bool isVisible)
    {
        VisibilityService.SetFieldVisibility(FieldName, isVisible);
    }
    
    private void ToggleVisibility()
    {
        OnVisibilityChanged.InvokeAsync(!ShowOptional);
    }
    
    public void Dispose()
    {
        VisibilityService.OnVisibilityChanged -= OnVisibilityChangedHandler;
    }

        private readonly string[] _targetPersonas =
        {
            "Adults", "Kids", "Teenagers", "Young Adults"
        };
        private void RemoveTargetPersona(string targetPersona)
        {
            if (File?.TargetPersonas == null) return;
            File.TargetPersonas.Remove(targetPersona);
        }
}