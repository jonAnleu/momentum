@inject FileUploadService FileState
@inject AssetService AssetService
@inject IWebHostEnvironment Env
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudButton Class="ma-4 py-3"
           Variant="Variant.Filled"
           Color="Color.Error"
           Size="Size.Large"
           OnClick="StoreFiles">
    <MudText Typo="Typo.subtitle2">
        <b>Store selected file</b>
    </MudText>
</MudButton>

@code {
    
   private async Task StoreFiles()
{
    try
    {
        foreach (var uploaded in FileState.PendingFiles)
        {
            // Validate uploaded file has data
            if (uploaded.Data == null || uploaded.Data.Length == 0)
            {
                Snackbar.Add($"Skipping {uploaded.Name} - no data", Severity.Warning);
                continue;
            }

            var ext = Path.GetExtension(uploaded.Name).TrimStart('.').ToLower();
            var uniqueName = $"{Guid.NewGuid()}.{ext}";

            var uploadsDir = Path.Combine(Env.WebRootPath, "uploads");
            Directory.CreateDirectory(uploadsDir);

            var filePath = Path.Combine(uploadsDir, uniqueName);

            // Write file to disk
            await File.WriteAllBytesAsync(filePath, uploaded.Data);

            // Create Asset with ALL metadata from UploadedFile
            var asset = new Asset
            {
                // Basic file info
                FileName = uploaded.Title ?? Path.GetFileNameWithoutExtension(uploaded.Name),
                FilePath = $"/uploads/{uniqueName}",
                FileType = ext,
                IsSelected = uploaded.IsSelected,
                
                // Metadata fields
                AssetType = uploaded.AssetType,
                AssetSubTypes = new List<string>(uploaded.AssetSubtypes), // Keep as List
                UsageRights = uploaded.UsageRights,
                UsageRightsDetails = uploaded.UsageRightsDetails,
                Goals = new List<string>(uploaded.Goals), // Create new list to avoid reference issues
                
                // Optional fields
                Description = uploaded.Description,
                Year = uploaded.Year,
                PublicationDate = uploaded.PublicationDate,
                PublicationTime = uploaded.PublicationTime,
                Copyright = uploaded.Copyright,
                TargetPersonas = new List<string>(uploaded.TargetPersonas),
                Channels = new List<string>(uploaded.Channels),
                Launches = new List<string>(uploaded.Launches),
                Themes = new List<string>(uploaded.Themes),
                Campaigns = new List<string>(uploaded.Campaigns),
                Installations = new List<string>(uploaded.Installations),
                Tags = new List<string>(uploaded.Tags),
                Collections = new List<string>(uploaded.Collections),
                
                // Timestamps
                CreatedDate = DateTime.Now
            };

            // Pass complete asset to service
            AssetService.AddAsset(asset);

            Snackbar.Add($"Stored {uploaded.Name} successfully", Severity.Success);
        }

        FileState.ClearFiles();
        Snackbar.Add("All files stored successfully", Severity.Success);
        Nav.NavigateTo("/");
    }
    catch (Exception ex)
    {
        Snackbar.Add($"Error storing files: {ex.Message}", Severity.Error);
    }
}
}