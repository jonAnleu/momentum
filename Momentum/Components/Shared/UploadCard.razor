@inject FieldVisibilityService VisibilityService

<style>
    .border-red {
        outline: solid 2px #A6192e;
    }
</style>

<MudCard Class="@($"cursor-pointer  {(File.IsSelected ? "border-red" : "")} {(Hovered ? "border-red" : "")}")"
         Outlined="true"
         Style="max-width: 232px; height: fit-content;"
         @onmouseenter="() => Hovered = true"
         @onmouseleave="() => Hovered = false">
    <div style="position: relative; height: 140px;" @onclick="Toggle">
        <MudCardMedia Class="rounded-t-sm" Image="@File.ThumbnailDataUrl" Height="140" Style="width: 100%; object-fit: cover;"/>
        <MudIconButton Href="/" Class="position-absolute"
                       Icon="@Icons.Material.Rounded.Close"
                       Variant="Variant.Filled"
                       Size="Size.Small"
                       Style="bottom: 130px; left: 10px; background-color: white; color: black;"
                       OnClick="RemoveFile"
        >
        </MudIconButton>

        <MudChip Class="position-absolute" T="string"
                 Label="true" Size="Size.Small"
                 Style="color: white; background: rgba(0, 0, 0, .5); bottom: 50px; left: 120px;">
            <b>@File.FileExtension</b>
        </MudChip>

        @if (Hovered || File.IsSelected)
        {
            <MudToggleIconButton Class="pa-0 position-absolute z-10 "
                                 Icon="@Icons.Material.Filled.RadioButtonUnchecked"
                                 Toggled="File.IsSelected"
                                 ToggledChanged="Toggle"
                                 Style="color: white; bottom: 130px; left: 95px;"
                                 ToggledIcon=@Icons.Material.Filled.CheckCircle
                                 ToggledColor="@Color.Error"
                                 Ripple="false"
                                 Size="Size.Large"
                                 ToggledSize="Size.Large"/>
        }

    </div>
    <MudCardContent Class="pa-2">
        <MudStack Spacing="1">
            <MudText Typo="Typo.caption"><b>Required fields</b></MudText>
            <TitleField File="File"/>
            <AssetTypeField File="File" AssetTypeChanged="OnAssetTypeChanged"/>
            @if (!string.IsNullOrWhiteSpace(File?.AssetType))
            {
                <AssetSubTypeField File="File" AssetType="@File.AssetType"/>
            }
            <UsageRightsField File="File"/>
            @if (File.UsageRights == "Special usage rights")
            {
                <PleaseSpecifyField File="File"/>
            }
            <GoalField File="File"/>
            @if (ShowOptionalFields)
            {
                <MudText Class="mt-2" Typo="Typo.caption"><b>Optional fields</b></MudText>
                <DescriptionField File="File"/>
                <PublicationDateField File="File"/>
                <TagsField/>
                <CopyrightField File="File"/>
                @if (ShowOptionalFields || VisibilityService.ShouldShowField("TargetPersona"))
                {
                    <TargetPersonaField File="File"/>
                }
                <ChannelField File="File"/>
                <LaunchField File="File"/>
                <YearField File="File"/>
                <ThemeField File="File"/>
                <CampaignField File="File"/>
                <InstallationsField File="File"/>
                <RelatedAssetsFields/>
            }
        </MudStack>
    </MudCardContent>
</MudCard>
@code {
    [Parameter] public UploadedFile? File { get; set; }
    [Parameter] public bool ShowOptionalFields { get; set; }
    [Parameter] public EventCallback<UploadedFile> OnToggleSelected { get; set; }
    [Parameter] public EventCallback<UploadedFile> OnRemoveFile { get; set; }
    [Parameter] public EventCallback OnFileChanged { get; set; }

    private bool Hovered { get; set; }

  
    protected override void OnInitialized()
    {
        VisibilityService.OnVisibilityChanged += OnVisibilityChanged;
    }

    private async void OnVisibilityChanged()
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task Toggle()
    {
        await OnToggleSelected.InvokeAsync(File);
    }

    private async Task RemoveFile(MouseEventArgs e)
    {
        if (File != null)
        {
            await OnRemoveFile.InvokeAsync(File);
        }
    }

    private void OnAssetTypeChanged(string assetType)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        VisibilityService.OnVisibilityChanged -= OnVisibilityChanged;
    }
}