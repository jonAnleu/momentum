@page "/Upload"
@layout UploadLayout
@inject FileUploadStateService FileState
@inject NavigationManager NavManager

<MudStack Class="mx-10 my-14" Row="true" StretchItems="StretchItems.End" Spacing="9">
    <UploadPanel File="_currentFile"
                 IsSelected="_currentFile.IsSelected"
                 ShowOptional="ShowAllOptionalFields"
                 OnVisibilityChanged="HandleVisibilityChanged" />

    @if (_currentFile != null)
    {
        <UploadCard File="_currentFile"
                    IsSelected="_currentFile.IsSelected"
                    ShowOptionalFields="ShowAllOptionalFields"
                    OnToggleSelected="HandleCardSelection"
                    OnRemoveFile="HandleRemoveFile"/>
    }
</MudStack>

@code {
    private UploadedFile? _currentFile;
    private bool ShowAllOptionalFields = false;

    protected override void OnInitialized()
    {
        if (FileState.PendingFiles.Any())
        {
            _currentFile = FileState.PendingFiles.First();
        }
        else
        {
            NavManager.NavigateTo("/");
        }
    }

    private void HandleCardSelection(UploadedFile file)
    {
        // Toggle selection state
        _currentFile.IsSelected = !_currentFile.IsSelected;
        StateHasChanged();
    }

    private void HandleVisibilityChanged(bool visible)
    {
        ShowAllOptionalFields = visible;
        StateHasChanged();
    }
    
    private void HandleRemoveFile(UploadedFile file)
    {
        if (_currentFile == file)
            _currentFile = null;
    
        _currentFile.IsSelected = false;
        StateHasChanged();
    }
}