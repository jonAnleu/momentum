@page "/Upload"
@layout UploadLayout
@inject FieldVisibilityService VisibilityService
@inject FileUploadService FileState
@inject NavigationManager NavManager

<MudStack Class="mx-5 my-2" Row="true" StretchItems="StretchItems.End" Spacing="9">
    <UploadPanel File="_currentFile"
                 OnFileChanged="StateHasChanged" 
                 ShowOptional="ShowAllOptionalFields"
                 OnVisibilityChanged="HandleGlobalVisibilityChanged" />
    <MudStack Spacing="4">
        <UploadBrowserToolbar File="_currentFile" 
                              OnSelectionChanged="HandleSelectionChanged" />
        <UploadCard File="_currentFile"
                    ShowOptionalFields="ShowAllOptionalFields"
                    OnToggleSelected="HandleToggleSelection"
                    OnRemoveFile="HandleRemoveFile"/>
    </MudStack>
</MudStack>

@code {
    private UploadedFile? _currentFile;
    private bool ShowAllOptionalFields = false;

    protected override void OnInitialized()
    {
        if (FileState.PendingFiles.Any())
        {
            _currentFile = FileState.PendingFiles.First();
        }
        else
        {
            NavManager.NavigateTo("/");
        }
    }

    private async Task HandleSelectionChanged(bool isSelected)
    {
        if (_currentFile != null)
        {
           _currentFile.IsSelected = isSelected;
            StateHasChanged();
            
        }
    }

    private async Task HandleToggleSelection(UploadedFile file)
    {
        await HandleSelectionChanged(!file.IsSelected);
    }

    private async Task HandleGlobalVisibilityChanged(bool isVisible)
    {
        ShowAllOptionalFields = isVisible;
        VisibilityService.GlobalVisibility = isVisible;
        StateHasChanged();
    }
    
    private void HandleRemoveFile(UploadedFile file)
    {
        FileState.PendingFiles.Remove(file);
        NavManager.NavigateTo("/");
    }
}