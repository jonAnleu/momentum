@page "/Upload"
@layout UploadLayout
@inject FileUploadStateService FileState
@inject NavigationManager NavManager

<MudStack Class="mx-5 my-2" Row="true" StretchItems="StretchItems.End" Spacing="9">
    <UploadPanel File="_currentFile"
                 OnFileChanged="StateHasChanged" 
                 IsSelected="_currentFile.IsSelected"
                 ShowOptional="ShowAllOptionalFields"
                 OnVisibilityChanged="HandleVisibilityChanged" />
    <MudStack Spacing="4">
        <UploadBrowserToolbar File="_currentFile" />
        <UploadCard File="_currentFile"
                    IsSelected="_currentFile.IsSelected"
                    ShowOptionalFields="ShowAllOptionalFields"
                    OnToggleSelected="HandleCardSelection"
                    OnRemoveFile="HandleRemoveFile"/>
        </MudStack>
</MudStack>

@code {
    private UploadedFile? _currentFile;
    private bool ShowAllOptionalFields = false;

    protected override void OnInitialized()
    {
        if (FileState.PendingFiles.Any())
        {
            _currentFile = FileState.PendingFiles.First();
        }
        else
        {
            NavManager.NavigateTo("/");
        }
    }

    private void HandleCardSelection(UploadedFile file)
    {
        if (_currentFile != null)  
        {
            _currentFile.IsSelected = !_currentFile.IsSelected;
            StateHasChanged();
        }
    }

    private void HandleVisibilityChanged(bool visible)
    {
        ShowAllOptionalFields = visible;
        StateHasChanged();
    }
    
    private void HandleRemoveFile(UploadedFile file)
    {
        FileState.PendingFiles.Remove(file);
        NavManager.NavigateTo("/");
    }
}